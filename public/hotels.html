<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hotel Search - Hotel Booking</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link rel="stylesheet" href="./css/styles.css" />
  <style>
    .room-entry { background: #f8f9fa; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; position: relative; }
    .room-entry .btn-remove { position: absolute; top: 0.5rem; right: 0.5rem; }
    .amenity-tag { display: inline-block; background: #e2e8f0; color: #334155; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.8rem; margin: 0.15rem; }
    .hotel-img-placeholder { width: 100%; height: 180px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 0.75rem 0.75rem 0 0; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 2rem; font-weight: bold; }
    .hotel-img-placeholder img { width: 100%; height: 180px; object-fit: cover; border-radius: 0.75rem 0.75rem 0 0; }
    .search-highlight { background: #fef3c7; padding: 0 2px; border-radius: 2px; }
    .btn-edit { background: #f59e0b; color: #fff; border: none; }
    .btn-edit:hover { background: #d97706; color: #fff; }
    .btn-delete { background: #ef4444; color: #fff; border: none; }
    .btn-delete:hover { background: #dc2626; color: #fff; }
    .card-actions { display: flex; gap: 0.5rem; }
    .card-actions .btn { flex: 1; font-size: 0.85rem; padding: 0.4rem 0.5rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark topbar sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="./hotels.html">Hotel Booking</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="./hotels.html">Hotels</a></li>
          <li class="nav-item"><a class="nav-link" href="./my-bookings.html">My Bookings</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="hotelBooking.logout()">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-4 py-md-5">
    <!-- Search Section -->
    <section class="card border-0 shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h3 mb-0">Search Hotels For Best Deals</h1>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addHotelModal">
            + Add Hotel
          </button>
        </div>
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-4">
            <label for="location" class="form-label">Search by Name or Location</label>
            <input id="location" class="form-control" placeholder="e.g. Goa, Taj, Mumbai" />
          </div>
          <div class="col-6 col-md-2">
            <label for="minPrice" class="form-label">Min Price (INR)</label>
            <input id="minPrice" type="number" min="0" class="form-control" placeholder="0" />
          </div>
          <div class="col-6 col-md-2">
            <label for="maxPrice" class="form-label">Max Price (INR)</label>
            <input id="maxPrice" type="number" min="0" class="form-control" placeholder="50000" />
          </div>
          <div class="col-6 col-md-2">
            <label for="minRating" class="form-label">Min Rating</label>
            <select id="minRating" class="form-select">
              <option value="">Any</option>
              <option value="3">3+ Stars</option>
              <option value="3.5">3.5+ Stars</option>
              <option value="4">4+ Stars</option>
              <option value="4.5">4.5+ Stars</option>
            </select>
          </div>
          <div class="col-6 col-md-2 d-grid">
            <button id="searchBtn" class="btn btn-primary">Search</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Results Count -->
    <div id="resultsInfo" class="mb-3 text-secondary small"></div>

    <!-- Hotel Results -->
    <section id="results" class="row g-3"></section>
  </main>

  <!-- Add Hotel Modal -->
  <div class="modal fade" id="addHotelModal" tabindex="-1" aria-labelledby="addHotelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addHotelModalLabel">Add New Hotel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addHotelForm">
            <!-- Hotel Details -->
            <h6 class="text-secondary mb-3">Hotel Details</h6>
            <div class="row g-3 mb-4">
              <div class="col-12 col-md-6">
                <label for="hotelName" class="form-label">Hotel Name <span class="text-danger">*</span></label>
                <input type="text" id="hotelName" class="form-control" placeholder="e.g. Taj Palace" required />
              </div>
              <div class="col-12 col-md-6">
                <label for="hotelLocation" class="form-label">Location <span class="text-danger">*</span></label>
                <input type="text" id="hotelLocation" class="form-control" placeholder="e.g. Mumbai, Maharashtra" required />
              </div>
              <div class="col-12">
                <label for="hotelDescription" class="form-label">Description</label>
                <textarea id="hotelDescription" class="form-control" rows="3" placeholder="Describe the hotel..."></textarea>
              </div>
              <div class="col-12 col-md-4">
                <label for="hotelRating" class="form-label">Rating (0-5)</label>
                <input type="number" id="hotelRating" class="form-control" min="0" max="5" step="0.1" placeholder="4.5" />
              </div>
              <div class="col-12 col-md-8">
                <label for="hotelImageUrl" class="form-label">Image URL</label>
                <input type="url" id="hotelImageUrl" class="form-control" placeholder="https://example.com/hotel.jpg" />
              </div>
              <div class="col-12">
                <label class="form-label">Amenities</label>
                <div class="d-flex flex-wrap gap-2 mb-2" id="amenitiesList"></div>
                <div class="input-group" style="max-width: 400px;">
                  <input type="text" id="amenityInput" class="form-control form-control-sm" placeholder="e.g. WiFi, Pool, Gym" />
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addAmenity()">Add</button>
                </div>
                <div class="mt-2">
                  <small class="text-muted">Quick add:</small>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Free WiFi')">WiFi</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Swimming Pool')">Pool</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Gym')">Gym</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Parking')">Parking</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Restaurant')">Restaurant</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Spa')">Spa</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Room Service')">Room Service</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('AC')">AC</button>
                </div>
              </div>
            </div>

            <!-- Rooms Section -->
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="text-secondary mb-0">Rooms</h6>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addRoomEntry()">+ Add Room</button>
            </div>
            <div id="roomsContainer"></div>

            <!-- Alert -->
            <div id="addHotelAlert" class="alert d-none mt-3"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="submitHotelBtn" onclick="submitHotel()">Add Hotel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Hotel Modal -->
  <div class="modal fade" id="editHotelModal" tabindex="-1" aria-labelledby="editHotelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editHotelModalLabel">Edit Hotel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editHotelForm">
            <input type="hidden" id="editHotelId" />
            <h6 class="text-secondary mb-3">Hotel Details</h6>
            <div class="row g-3 mb-4">
              <div class="col-12 col-md-6">
                <label for="editHotelName" class="form-label">Hotel Name <span class="text-danger">*</span></label>
                <input type="text" id="editHotelName" class="form-control" placeholder="e.g. Taj Palace" required />
              </div>
              <div class="col-12 col-md-6">
                <label for="editHotelLocation" class="form-label">Location <span class="text-danger">*</span></label>
                <input type="text" id="editHotelLocation" class="form-control" placeholder="e.g. Mumbai, Maharashtra" required />
              </div>
              <div class="col-12">
                <label for="editHotelDescription" class="form-label">Description</label>
                <textarea id="editHotelDescription" class="form-control" rows="3" placeholder="Describe the hotel..."></textarea>
              </div>
              <div class="col-12 col-md-4">
                <label for="editHotelRating" class="form-label">Rating (0-5)</label>
                <input type="number" id="editHotelRating" class="form-control" min="0" max="5" step="0.1" placeholder="4.5" />
              </div>
              <div class="col-12 col-md-8">
                <label for="editHotelImageUrl" class="form-label">Image URL</label>
                <input type="url" id="editHotelImageUrl" class="form-control" placeholder="https://example.com/hotel.jpg" />
              </div>
              <div class="col-12">
                <label class="form-label">Amenities</label>
                <div class="d-flex flex-wrap gap-2 mb-2" id="editAmenitiesList"></div>
                <div class="input-group" style="max-width: 400px;">
                  <input type="text" id="editAmenityInput" class="form-control form-control-sm" placeholder="e.g. WiFi, Pool, Gym" />
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEditAmenity()">Add</button>
                </div>
                <div class="mt-2">
                  <small class="text-muted">Quick add:</small>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddEditAmenity('Free WiFi')">WiFi</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddEditAmenity('Swimming Pool')">Pool</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddEditAmenity('Gym')">Gym</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddEditAmenity('Parking')">Parking</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddEditAmenity('Restaurant')">Restaurant</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddEditAmenity('Spa')">Spa</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddEditAmenity('Room Service')">Room Service</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddEditAmenity('AC')">AC</button>
                </div>
              </div>
            </div>

            <!-- Edit Rooms Section -->
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="text-secondary mb-0">Rooms</h6>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEditRoomEntry()">+ Add Room</button>
            </div>
            <div id="editRoomsContainer"></div>

            <!-- Alert -->
            <div id="editHotelAlert" class="alert d-none mt-3"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="updateHotelBtn" onclick="updateHotel()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteHotelModal" tabindex="-1" aria-labelledby="deleteHotelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteHotelModalLabel">Delete Hotel</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="deleteHotelId" />
          <p class="mb-1">Are you sure you want to delete this hotel?</p>
          <p class="fw-bold mb-2" id="deleteHotelName"></p>
          <div class="alert alert-warning py-2 mb-0">
            <small>This will permanently delete the hotel and all its rooms. This action cannot be undone.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteHotel()">Delete Hotel</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer-site mt-auto py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-4 mb-3 mb-md-0">
          <h5 class="fw-bold text-white mb-2">Hotel Booking</h5>
          <p class="text-white-50 small mb-0">Find and book the best hotels for your next trip.</p>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
          <h6 class="text-white mb-2">Quick Links</h6>
          <ul class="list-unstyled mb-0">
            <li><a href="./hotels.html" class="footer-link">Search Hotels</a></li>
            <li><a href="./my-bookings.html" class="footer-link">My Bookings</a></li>
            <li><a href="./login.html" class="footer-link">Login</a></li>
            <li><a href="./register.html" class="footer-link">Register</a></li>
          </ul>
        </div>
        <div class="col-md-4">
          <h6 class="text-white mb-2">Contact</h6>
          <ul class="list-unstyled mb-0">
            <li class="text-white-50 small">Email: support@hotelbooking.com</li>
            <li class="text-white-50 small">Phone: +91 1234567890</li>
          </ul>
        </div>
      </div>
      <hr class="border-secondary my-3">
      <p class="text-white-50 text-center small mb-0">&copy; 2026 Hotel Booking. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="./js/common.js"></script>
  <script>
    hotelBooking.ensureAuth();

    // ---- Amenities Management (Add Modal) ----
    let amenities = [];

    function renderAmenities() {
      const list = document.getElementById('amenitiesList');
      list.innerHTML = amenities.map((a, i) =>
        `<span class="amenity-tag">${a} <span style="cursor:pointer;margin-left:4px;" onclick="removeAmenity(${i})">&times;</span></span>`
      ).join('');
    }

    function addAmenity() {
      const input = document.getElementById('amenityInput');
      const val = input.value.trim();
      if (val && !amenities.includes(val)) {
        amenities.push(val);
        renderAmenities();
      }
      input.value = '';
      input.focus();
    }

    function quickAddAmenity(val) {
      if (!amenities.includes(val)) {
        amenities.push(val);
        renderAmenities();
      }
    }

    function removeAmenity(index) {
      amenities.splice(index, 1);
      renderAmenities();
    }

    document.getElementById('amenityInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); addAmenity(); }
    });

    // ---- Amenities Management (Edit Modal) ----
    let editAmenities = [];

    function renderEditAmenities() {
      const list = document.getElementById('editAmenitiesList');
      list.innerHTML = editAmenities.map((a, i) =>
        `<span class="amenity-tag">${a} <span style="cursor:pointer;margin-left:4px;" onclick="removeEditAmenity(${i})">&times;</span></span>`
      ).join('');
    }

    function addEditAmenity() {
      const input = document.getElementById('editAmenityInput');
      const val = input.value.trim();
      if (val && !editAmenities.includes(val)) {
        editAmenities.push(val);
        renderEditAmenities();
      }
      input.value = '';
      input.focus();
    }

    function quickAddEditAmenity(val) {
      if (!editAmenities.includes(val)) {
        editAmenities.push(val);
        renderEditAmenities();
      }
    }

    function removeEditAmenity(index) {
      editAmenities.splice(index, 1);
      renderEditAmenities();
    }

    document.getElementById('editAmenityInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); addEditAmenity(); }
    });

    // ---- Rooms Management (Add Modal) ----
    let roomCount = 0;

    function addRoomEntry() {
      roomCount++;
      const container = document.getElementById('roomsContainer');
      const div = document.createElement('div');
      div.className = 'room-entry';
      div.id = `room-${roomCount}`;
      div.innerHTML = `
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove" onclick="removeRoom('room-${roomCount}')">&times;</button>
        <div class="row g-2">
          <div class="col-12 col-md-4">
            <label class="form-label small">Room Type</label>
            <select class="form-select form-select-sm room-type">
              <option value="Standard">Standard</option>
              <option value="Deluxe">Deluxe</option>
              <option value="Suite">Suite</option>
              <option value="Premium">Premium</option>
              <option value="Family">Family</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">Price/Night (INR)</label>
            <input type="number" class="form-control form-control-sm room-price" min="0" placeholder="2000" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">Capacity</label>
            <input type="number" class="form-control form-control-sm room-capacity" min="1" max="10" value="2" />
          </div>
          <div class="col-12 col-md-2 d-flex align-items-end">
            <span class="badge bg-success">Available</span>
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    function removeRoom(id) {
      document.getElementById(id).remove();
    }

    addRoomEntry();

    // ---- Rooms Management (Edit Modal) ----
    let editRoomCount = 0;

    function addEditRoomEntry(roomData) {
      editRoomCount++;
      const container = document.getElementById('editRoomsContainer');
      const div = document.createElement('div');
      div.className = 'room-entry';
      div.id = `edit-room-${editRoomCount}`;

      const roomType = roomData ? roomData.room_type : 'Standard';
      const price = roomData ? (roomData.price_per_night || roomData.price) : '';
      const capacity = roomData ? roomData.capacity : 2;

      div.innerHTML = `
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove" onclick="removeEditRoom('edit-room-${editRoomCount}')">&times;</button>
        <div class="row g-2">
          <div class="col-12 col-md-4">
            <label class="form-label small">Room Type</label>
            <select class="form-select form-select-sm room-type">
              <option value="Standard" ${roomType === 'Standard' ? 'selected' : ''}>Standard</option>
              <option value="Deluxe" ${roomType === 'Deluxe' ? 'selected' : ''}>Deluxe</option>
              <option value="Suite" ${roomType === 'Suite' ? 'selected' : ''}>Suite</option>
              <option value="Premium" ${roomType === 'Premium' ? 'selected' : ''}>Premium</option>
              <option value="Family" ${roomType === 'Family' ? 'selected' : ''}>Family</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">Price/Night (INR)</label>
            <input type="number" class="form-control form-control-sm room-price" min="0" placeholder="2000" value="${price}" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">Capacity</label>
            <input type="number" class="form-control form-control-sm room-capacity" min="1" max="10" value="${capacity}" />
          </div>
          <div class="col-12 col-md-2 d-flex align-items-end">
            <span class="badge bg-success">Available</span>
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    function removeEditRoom(id) {
      document.getElementById(id).remove();
    }

    // ---- Submit Hotel (Add) ----
    async function submitHotel() {
      const alert = document.getElementById('addHotelAlert');
      alert.className = 'alert d-none mt-3';

      const name = document.getElementById('hotelName').value.trim();
      const location = document.getElementById('hotelLocation').value.trim();
      const description = document.getElementById('hotelDescription').value.trim();
      const rating = parseFloat(document.getElementById('hotelRating').value) || 0;
      const image_url = document.getElementById('hotelImageUrl').value.trim();

      if (!name || !location) {
        alert.className = 'alert alert-danger mt-3';
        alert.textContent = 'Hotel name and location are required.';
        return;
      }

      const roomEntries = document.querySelectorAll('#roomsContainer .room-entry');
      const rooms = [];
      for (const entry of roomEntries) {
        const room_type = entry.querySelector('.room-type').value;
        const price = parseFloat(entry.querySelector('.room-price').value);
        const capacity = parseInt(entry.querySelector('.room-capacity').value) || 2;

        if (!price || price <= 0) {
          alert.className = 'alert alert-danger mt-3';
          alert.textContent = 'Please enter a valid price for all rooms.';
          return;
        }

        rooms.push({ room_type, price_per_night: price, capacity });
      }

      const submitBtn = document.getElementById('submitHotelBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding...';

      try {
        const payload = { name, location, description, rating, amenities, image_url, rooms };
        const result = await hotelBooking.api.request('/api/hotels', {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        alert.className = 'alert alert-success mt-3';
        alert.textContent = 'Hotel added successfully! "' + (result.hotel ? result.hotel.name : name) + '"';

        setTimeout(() => {
          document.getElementById('addHotelForm').reset();
          amenities = [];
          renderAmenities();
          document.getElementById('roomsContainer').innerHTML = '';
          roomCount = 0;
          addRoomEntry();
          alert.className = 'alert d-none mt-3';

          const modal = bootstrap.Modal.getInstance(document.getElementById('addHotelModal'));
          if (modal) modal.hide();
          loadHotels();
        }, 1500);
      } catch (error) {
        alert.className = 'alert alert-danger mt-3';
        if (error.status === 401) {
          alert.textContent = 'You must be logged in to add a hotel. Please login first.';
        } else if (error.status === 400) {
          alert.textContent = 'Validation error: ' + error.message;
        } else {
          alert.textContent = error.message || 'Failed to add hotel. Please try again.';
        }
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Hotel';
      }
    }

    // ---- Open Edit Modal ----
    function openEditModal(hotelId) {
      const alert = document.getElementById('editHotelAlert');
      alert.className = 'alert d-none mt-3';

      // Fetch hotel data
      hotelBooking.api.request(`/api/hotels/${hotelId}`).then(data => {
        const hotel = data.hotel;
        document.getElementById('editHotelId').value = hotel.id;
        document.getElementById('editHotelName').value = hotel.name || '';
        document.getElementById('editHotelLocation').value = hotel.location || '';
        document.getElementById('editHotelDescription').value = hotel.description || '';
        document.getElementById('editHotelRating').value = hotel.rating || '';
        document.getElementById('editHotelImageUrl').value = hotel.image_url || '';

        // Load amenities
        editAmenities = Array.isArray(hotel.amenities) ? [...hotel.amenities] : [];
        renderEditAmenities();

        // Load rooms (rooms are returned as data.rooms, not hotel.rooms)
        document.getElementById('editRoomsContainer').innerHTML = '';
        editRoomCount = 0;
        const rooms = data.rooms || [];
        if (rooms.length > 0) {
          rooms.forEach(room => addEditRoomEntry(room));
        } else {
          addEditRoomEntry();
        }

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editHotelModal'));
        modal.show();
      }).catch(error => {
        window.alert('Failed to load hotel details: ' + error.message);
      });
    }

    // ---- Update Hotel (Edit) ----
    async function updateHotel() {
      const alert = document.getElementById('editHotelAlert');
      alert.className = 'alert d-none mt-3';

      const hotelId = document.getElementById('editHotelId').value;
      const name = document.getElementById('editHotelName').value.trim();
      const location = document.getElementById('editHotelLocation').value.trim();
      const description = document.getElementById('editHotelDescription').value.trim();
      const rating = parseFloat(document.getElementById('editHotelRating').value) || 0;
      const image_url = document.getElementById('editHotelImageUrl').value.trim();

      if (!name || !location) {
        alert.className = 'alert alert-danger mt-3';
        alert.textContent = 'Hotel name and location are required.';
        return;
      }

      const roomEntries = document.querySelectorAll('#editRoomsContainer .room-entry');
      const rooms = [];
      for (const entry of roomEntries) {
        const room_type = entry.querySelector('.room-type').value;
        const price = parseFloat(entry.querySelector('.room-price').value);
        const capacity = parseInt(entry.querySelector('.room-capacity').value) || 2;

        if (!price || price <= 0) {
          alert.className = 'alert alert-danger mt-3';
          alert.textContent = 'Please enter a valid price for all rooms.';
          return;
        }

        rooms.push({ room_type, price_per_night: price, capacity });
      }

      const updateBtn = document.getElementById('updateHotelBtn');
      updateBtn.disabled = true;
      updateBtn.textContent = 'Saving...';

      try {
        const payload = { name, location, description, rating, amenities: editAmenities, image_url, rooms };
        const result = await hotelBooking.api.request(`/api/hotels/update/${hotelId}`, {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        alert.className = 'alert alert-success mt-3';
        alert.textContent = 'Hotel updated successfully!';

        setTimeout(() => {
          alert.className = 'alert d-none mt-3';
          const modal = bootstrap.Modal.getInstance(document.getElementById('editHotelModal'));
          if (modal) modal.hide();
          loadHotels();
        }, 1500);
      } catch (error) {
        alert.className = 'alert alert-danger mt-3';
        if (error.status === 404) {
          alert.textContent = 'Hotel not found. It may have been deleted.';
        } else if (error.status === 400) {
          alert.textContent = 'Validation error: ' + error.message;
        } else {
          alert.textContent = error.message || 'Failed to update hotel. Please try again.';
        }
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = 'Save Changes';
      }
    }

    // ---- Open Delete Confirmation ----
    function openDeleteModal(hotelId, hotelName) {
      document.getElementById('deleteHotelId').value = hotelId;
      document.getElementById('deleteHotelName').textContent = '"' + hotelName + '"';
      const modal = new bootstrap.Modal(document.getElementById('deleteHotelModal'));
      modal.show();
    }

    // ---- Confirm Delete Hotel ----
    async function confirmDeleteHotel() {
      const hotelId = document.getElementById('deleteHotelId').value;
      const deleteBtn = document.getElementById('confirmDeleteBtn');
      deleteBtn.disabled = true;
      deleteBtn.textContent = 'Deleting...';

      try {
        await hotelBooking.api.request(`/api/hotels/delete/${hotelId}`, {
          method: 'POST'
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteHotelModal'));
        if (modal) modal.hide();
        loadHotels();
      } catch (error) {
        window.alert('Failed to delete hotel: ' + error.message);
      } finally {
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'Delete Hotel';
      }
    }

    // ---- Load & Search Hotels ----
    async function loadHotels() {
      const params = new URLSearchParams();
      const location = document.getElementById('location').value.trim();
      const minPrice = document.getElementById('minPrice').value;
      const maxPrice = document.getElementById('maxPrice').value;
      const minRating = document.getElementById('minRating').value;

      if (location) params.set('location', location);
      if (minPrice) params.set('min_price', minPrice);
      if (maxPrice) params.set('max_price', maxPrice);
      if (minRating) params.set('rating', minRating);

      const results = document.getElementById('results');
      const info = document.getElementById('resultsInfo');

      results.innerHTML = `
        <div class="col-12 text-center py-5">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
          <p class="mt-2 text-secondary">Searching hotels...</p>
        </div>`;

      try {
        const data = await hotelBooking.api.request(`/api/hotels?${params.toString()}`);
        const hotels = data.hotels || [];
        const pagination = data.pagination || {};

        if (hotels.length > 0) {
          info.textContent = `Showing ${hotels.length} of ${pagination.total || hotels.length} hotel(s)` +
            (location ? ` matching "${location}"` : '');
        } else {
          info.textContent = '';
        }

        if (!hotels.length) {
          results.innerHTML = `
            <div class="col-12">
              <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                  <p class="h5 mb-2">No hotels found</p>
                  <p class="text-secondary mb-3">${location ? `No results for "${location}". Try a different search.` : 'No hotels available yet.'}</p>
                  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addHotelModal">+ Add the first hotel</button>
                </div>
              </div>
            </div>`;
          return;
        }

        results.innerHTML = hotels.map((hotel) => {
          const roomCount = parseInt(hotel.total_rooms) || 0;
          const minP = parseFloat(hotel.min_room_price) || 0;
          const maxP = parseFloat(hotel.max_room_price) || 0;
          const amenitiesArr = Array.isArray(hotel.amenities) ? hotel.amenities : [];

          const imgHtml = hotel.image_url
            ? `<div class="hotel-img-placeholder"><img src="${hotel.image_url}" alt="${hotel.name}" onerror="this.parentElement.innerHTML='<span>${hotel.name.charAt(0)}</span>'" /></div>`
            : `<div class="hotel-img-placeholder"><span>${hotel.name.charAt(0)}</span></div>`;

          const escapedName = hotel.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');

          return `
          <div class="col-12 col-md-6 col-lg-4">
            <article class="card border-0 shadow-sm h-100" style="overflow:hidden;">
              ${imgHtml}
              <div class="card-body d-flex flex-column">
                <h2 class="h5 mb-1">${hotel.name}</h2>
                <p class="text-secondary small mb-2">${hotel.location}</p>
                <p class="text-secondary small mb-2" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${hotel.description || ''}</p>
                ${amenitiesArr.length > 0 ? `<div class="mb-2">${amenitiesArr.slice(0, 4).map(a => `<span class="amenity-tag">${a}</span>`).join('')}${amenitiesArr.length > 4 ? `<span class="amenity-tag">+${amenitiesArr.length - 4} more</span>` : ''}</div>` : ''}
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="badge bg-warning text-dark">Rating: ${hotel.rating || 'N/A'}</span>
                  <span class="small text-secondary">${roomCount} room(s)</span>
                </div>
                <p class="fw-semibold mb-3">${roomCount > 0 ? `INR ${minP.toLocaleString()}${minP !== maxP ? ` - ${maxP.toLocaleString()}` : ''} / night` : 'No rooms listed'}</p>
                <div class="mt-auto">
                  <div class="d-grid mb-2">
                    <button class="btn btn-outline-primary" onclick="window.location.href='./hotel.html?id=${hotel.id}'">View Details & Book</button>
                  </div>
                  <div class="card-actions">
                    <button class="btn btn-edit" onclick="openEditModal(${hotel.id})">Edit</button>
                    <button class="btn btn-delete" onclick="openDeleteModal(${hotel.id}, '${escapedName}')">Delete</button>
                  </div>
                </div>
              </div>
            </article>
          </div>`;
        }).join('');
      } catch (error) {
        info.textContent = '';
        results.innerHTML = `
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-body text-center py-4">
                <p class="text-danger mb-0">${error.message}</p>
              </div>
            </div>
          </div>`;
      }
    }

    document.getElementById('searchBtn').addEventListener('click', loadHotels);

    document.getElementById('location').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') loadHotels();
    });

    loadHotels();
  </script>
  <script src="https://widget.vibeback.io/v1/loader.js" data-widget-id="wgt_9wIDaxoB5VcXCstp" data-domain="ranvijay.capricorn.online/sumit"></script>
</body>
</html>
