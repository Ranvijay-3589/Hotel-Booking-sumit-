<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hotel Search - Hotel Booking</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link rel="stylesheet" href="./css/styles.css" />
  <style>
    .room-entry { background: #f8f9fa; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; position: relative; }
    .room-entry .btn-remove { position: absolute; top: 0.5rem; right: 0.5rem; }
    .amenity-tag { display: inline-block; background: #e2e8f0; color: #334155; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.8rem; margin: 0.15rem; }
    .hotel-img-placeholder { width: 100%; height: 180px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 0.75rem 0.75rem 0 0; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 2rem; font-weight: bold; }
    .hotel-img-placeholder img { width: 100%; height: 180px; object-fit: cover; border-radius: 0.75rem 0.75rem 0 0; }
    .search-highlight { background: #fef3c7; padding: 0 2px; border-radius: 2px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark topbar sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="./hotels.html">Hotel Booking</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="./hotels.html">Hotels</a></li>
          <li class="nav-item"><a class="nav-link" href="./my-bookings.html">My Bookings</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="hotelBooking.logout()">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-4 py-md-5">
    <!-- Search Section -->
    <section class="card border-0 shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h3 mb-0">Search Hotels</h1>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addHotelModal">
            + Add Hotel
          </button>
        </div>
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-4">
            <label for="location" class="form-label">Search by Name or Location</label>
            <input id="location" class="form-control" placeholder="e.g. Goa, Taj, Mumbai" />
          </div>
          <div class="col-6 col-md-3">
            <label for="minPrice" class="form-label">Min Price (INR)</label>
            <input id="minPrice" type="number" min="0" class="form-control" placeholder="0" />
          </div>
          <div class="col-6 col-md-3">
            <label for="maxPrice" class="form-label">Max Price (INR)</label>
            <input id="maxPrice" type="number" min="0" class="form-control" placeholder="50000" />
          </div>
          <div class="col-12 col-md-2 d-grid">
            <button id="searchBtn" class="btn btn-primary">Search</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Results Count -->
    <div id="resultsInfo" class="mb-3 text-secondary small"></div>

    <!-- Hotel Results -->
    <section id="results" class="row g-3"></section>
  </main>

  <!-- Add Hotel Modal -->
  <div class="modal fade" id="addHotelModal" tabindex="-1" aria-labelledby="addHotelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addHotelModalLabel">Add New Hotel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addHotelForm">
            <!-- Hotel Details -->
            <h6 class="text-secondary mb-3">Hotel Details</h6>
            <div class="row g-3 mb-4">
              <div class="col-12 col-md-6">
                <label for="hotelName" class="form-label">Hotel Name <span class="text-danger">*</span></label>
                <input type="text" id="hotelName" class="form-control" placeholder="e.g. Taj Palace" required />
              </div>
              <div class="col-12 col-md-6">
                <label for="hotelLocation" class="form-label">Location <span class="text-danger">*</span></label>
                <input type="text" id="hotelLocation" class="form-control" placeholder="e.g. Mumbai, Maharashtra" required />
              </div>
              <div class="col-12">
                <label for="hotelDescription" class="form-label">Description</label>
                <textarea id="hotelDescription" class="form-control" rows="3" placeholder="Describe the hotel..."></textarea>
              </div>
              <div class="col-12 col-md-4">
                <label for="hotelRating" class="form-label">Rating (0-5)</label>
                <input type="number" id="hotelRating" class="form-control" min="0" max="5" step="0.1" placeholder="4.5" />
              </div>
              <div class="col-12 col-md-8">
                <label for="hotelImageUrl" class="form-label">Image URL</label>
                <input type="url" id="hotelImageUrl" class="form-control" placeholder="https://example.com/hotel.jpg" />
              </div>
              <div class="col-12">
                <label class="form-label">Amenities</label>
                <div class="d-flex flex-wrap gap-2 mb-2" id="amenitiesList"></div>
                <div class="input-group" style="max-width: 400px;">
                  <input type="text" id="amenityInput" class="form-control form-control-sm" placeholder="e.g. WiFi, Pool, Gym" />
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addAmenity()">Add</button>
                </div>
                <div class="mt-2">
                  <small class="text-muted">Quick add:</small>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Free WiFi')">WiFi</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Swimming Pool')">Pool</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Gym')">Gym</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Parking')">Parking</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Restaurant')">Restaurant</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Spa')">Spa</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('Room Service')">Room Service</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm mx-1 mt-1" onclick="quickAddAmenity('AC')">AC</button>
                </div>
              </div>
            </div>

            <!-- Rooms Section -->
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="text-secondary mb-0">Rooms</h6>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addRoomEntry()">+ Add Room</button>
            </div>
            <div id="roomsContainer"></div>

            <!-- Alert -->
            <div id="addHotelAlert" class="alert d-none mt-3"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="submitHotelBtn" onclick="submitHotel()">Add Hotel</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="./js/common.js"></script>
  <script>
    hotelBooking.ensureAuth();

    // ---- Amenities Management ----
    let amenities = [];

    function renderAmenities() {
      const list = document.getElementById('amenitiesList');
      list.innerHTML = amenities.map((a, i) =>
        `<span class="amenity-tag">${a} <span style="cursor:pointer;margin-left:4px;" onclick="removeAmenity(${i})">&times;</span></span>`
      ).join('');
    }

    function addAmenity() {
      const input = document.getElementById('amenityInput');
      const val = input.value.trim();
      if (val && !amenities.includes(val)) {
        amenities.push(val);
        renderAmenities();
      }
      input.value = '';
      input.focus();
    }

    function quickAddAmenity(val) {
      if (!amenities.includes(val)) {
        amenities.push(val);
        renderAmenities();
      }
    }

    function removeAmenity(index) {
      amenities.splice(index, 1);
      renderAmenities();
    }

    // Handle Enter key in amenity input
    document.getElementById('amenityInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); addAmenity(); }
    });

    // ---- Rooms Management ----
    let roomCount = 0;

    function addRoomEntry() {
      roomCount++;
      const container = document.getElementById('roomsContainer');
      const div = document.createElement('div');
      div.className = 'room-entry';
      div.id = `room-${roomCount}`;
      div.innerHTML = `
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove" onclick="removeRoom('room-${roomCount}')">&times;</button>
        <div class="row g-2">
          <div class="col-12 col-md-4">
            <label class="form-label small">Room Type</label>
            <select class="form-select form-select-sm room-type">
              <option value="Standard">Standard</option>
              <option value="Deluxe">Deluxe</option>
              <option value="Suite">Suite</option>
              <option value="Premium">Premium</option>
              <option value="Family">Family</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">Price/Night (INR)</label>
            <input type="number" class="form-control form-control-sm room-price" min="0" placeholder="2000" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">Capacity</label>
            <input type="number" class="form-control form-control-sm room-capacity" min="1" max="10" value="2" />
          </div>
          <div class="col-12 col-md-2 d-flex align-items-end">
            <span class="badge bg-success">Available</span>
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    function removeRoom(id) {
      document.getElementById(id).remove();
    }

    // Add one room by default
    addRoomEntry();

    // ---- Submit Hotel ----
    async function submitHotel() {
      const alert = document.getElementById('addHotelAlert');
      alert.className = 'alert d-none mt-3';

      const name = document.getElementById('hotelName').value.trim();
      const location = document.getElementById('hotelLocation').value.trim();
      const description = document.getElementById('hotelDescription').value.trim();
      const rating = parseFloat(document.getElementById('hotelRating').value) || 0;
      const image_url = document.getElementById('hotelImageUrl').value.trim();

      if (!name || !location) {
        alert.className = 'alert alert-danger mt-3';
        alert.textContent = 'Hotel name and location are required.';
        return;
      }

      // Collect rooms
      const roomEntries = document.querySelectorAll('#roomsContainer .room-entry');
      const rooms = [];
      for (const entry of roomEntries) {
        const room_type = entry.querySelector('.room-type').value;
        const price = parseFloat(entry.querySelector('.room-price').value);
        const capacity = parseInt(entry.querySelector('.room-capacity').value) || 2;

        if (!price || price <= 0) {
          alert.className = 'alert alert-danger mt-3';
          alert.textContent = 'Please enter a valid price for all rooms.';
          return;
        }

        rooms.push({ room_type, price_per_night: price, capacity });
      }

      const submitBtn = document.getElementById('submitHotelBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding...';

      try {
        const payload = { name, location, description, rating, amenities, image_url, rooms };
        console.log('Submitting hotel:', JSON.stringify(payload));

        await hotelBooking.api.request('/api/hotels', {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        alert.className = 'alert alert-success mt-3';
        alert.textContent = 'Hotel added successfully!';

        // Reset form after short delay
        setTimeout(() => {
          document.getElementById('addHotelForm').reset();
          amenities = [];
          renderAmenities();
          document.getElementById('roomsContainer').innerHTML = '';
          roomCount = 0;
          addRoomEntry();
          alert.className = 'alert d-none mt-3';

          // Close modal and reload list
          bootstrap.Modal.getInstance(document.getElementById('addHotelModal')).hide();
          loadHotels();
        }, 1000);
      } catch (error) {
        alert.className = 'alert alert-danger mt-3';
        if (error.status === 401) {
          alert.textContent = 'You must be logged in to add a hotel. Please login first.';
        } else {
          alert.textContent = error.message || 'Failed to add hotel.';
        }
        console.error('Add hotel error:', error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Hotel';
      }
    }

    // ---- Load & Search Hotels ----
    async function loadHotels() {
      const params = new URLSearchParams();
      const location = document.getElementById('location').value.trim();
      const minPrice = document.getElementById('minPrice').value;
      const maxPrice = document.getElementById('maxPrice').value;

      if (location) params.set('location', location);
      if (minPrice) params.set('min_price', minPrice);
      if (maxPrice) params.set('max_price', maxPrice);

      const results = document.getElementById('results');
      const info = document.getElementById('resultsInfo');

      // Show loading
      results.innerHTML = `
        <div class="col-12 text-center py-5">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
          <p class="mt-2 text-secondary">Searching hotels...</p>
        </div>`;

      try {
        const data = await hotelBooking.api.request(`/api/hotels?${params.toString()}`);
        const hotels = data.hotels || [];
        const pagination = data.pagination || {};

        // Results info
        if (hotels.length > 0) {
          info.textContent = `Showing ${hotels.length} of ${pagination.total || hotels.length} hotel(s)` +
            (location ? ` matching "${location}"` : '');
        } else {
          info.textContent = '';
        }

        if (!hotels.length) {
          results.innerHTML = `
            <div class="col-12">
              <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                  <p class="h5 mb-2">No hotels found</p>
                  <p class="text-secondary mb-3">${location ? `No results for "${location}". Try a different search.` : 'No hotels available yet.'}</p>
                  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addHotelModal">+ Add the first hotel</button>
                </div>
              </div>
            </div>`;
          return;
        }

        results.innerHTML = hotels.map((hotel) => {
          const rooms = hotel.rooms || [];
          const prices = rooms.map(r => parseFloat(r.price_per_night)).filter(p => !isNaN(p));
          const minP = prices.length > 0 ? Math.min(...prices) : 0;
          const maxP = prices.length > 0 ? Math.max(...prices) : 0;
          const amenitiesArr = Array.isArray(hotel.amenities) ? hotel.amenities : [];

          const imgHtml = hotel.image_url
            ? `<div class="hotel-img-placeholder"><img src="${hotel.image_url}" alt="${hotel.name}" onerror="this.parentElement.innerHTML='<span>${hotel.name.charAt(0)}</span>'" /></div>`
            : `<div class="hotel-img-placeholder"><span>${hotel.name.charAt(0)}</span></div>`;

          return `
          <div class="col-12 col-md-6 col-lg-4">
            <article class="card border-0 shadow-sm h-100" style="overflow:hidden;">
              ${imgHtml}
              <div class="card-body d-flex flex-column">
                <h2 class="h5 mb-1">${hotel.name}</h2>
                <p class="text-secondary small mb-2">${hotel.location}</p>
                <p class="text-secondary small mb-2" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${hotel.description || ''}</p>
                ${amenitiesArr.length > 0 ? `<div class="mb-2">${amenitiesArr.slice(0, 4).map(a => `<span class="amenity-tag">${a}</span>`).join('')}${amenitiesArr.length > 4 ? `<span class="amenity-tag">+${amenitiesArr.length - 4} more</span>` : ''}</div>` : ''}
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="badge bg-warning text-dark">Rating: ${hotel.rating || 'N/A'}</span>
                  <span class="small text-secondary">${rooms.length} room(s)</span>
                </div>
                <p class="fw-semibold mb-3">${prices.length > 0 ? `INR ${minP.toLocaleString()}${minP !== maxP ? ` - ${maxP.toLocaleString()}` : ''} / night` : 'No rooms listed'}</p>
                <div class="mt-auto d-grid">
                  <button class="btn btn-outline-primary" onclick="window.location.href='./hotel.html?id=${hotel.id}'">View Details & Book</button>
                </div>
              </div>
            </article>
          </div>`;
        }).join('');
      } catch (error) {
        info.textContent = '';
        results.innerHTML = `
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-body text-center py-4">
                <p class="text-danger mb-0">${error.message}</p>
              </div>
            </div>
          </div>`;
      }
    }

    // Search on button click
    document.getElementById('searchBtn').addEventListener('click', loadHotels);

    // Search on Enter key in search input
    document.getElementById('location').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') loadHotels();
    });

    // Initial load
    loadHotels();
  </script>
</body>
</html>
